$schema: "https://raw.githubusercontent.com/omnigres/omnigres/master/pg_yregress/schema.json"
instance:
  init:
  - create extension omni_vfs cascade
  - create extension omni_var cascade
  - create extension omni_credentials cascade
  - create schema creds
  # FIXME: we use PATH because we can't set env variables yet
  - select omni_credentials.instantiate('creds', env_var => 'PATH')
  - create schema creds1
  # FIXME: we use PATH because we can't set env variables yet
  - select omni_credentials.instantiate('creds1', env_var => 'PATH')
  - select omni_var.set_session(
      'fs',
      omni_vfs.remote_fs('dbname=yregress user=yregress host=127.0.0.1 port = ' || current_setting('port'),
      $$omni_vfs.local_fs('../../../../extensions/omni_vfs/tests')$$)
    )
  - select omni_vfs.write(omni_var.get_session('fs', null::omni_vfs.remote_fs), '/creds.txt', decode('YiAzCg==', 'base64'), create_file => true)

tests:

- name: exports credentials to a file store upon instantiation
  commit: true
  steps:
  - insert into creds.credentials (name, value) values ('a', 'b')
  - select omni_credentials.instantiate_file_store(
      omni_var.get_session('fs', null::omni_vfs.remote_fs),
      '/creds.txt',
      'creds'
    )
  # Not one to one translation with pg_stat_file as it will not error out if file is not present.
  - select omni_vfs.file_info(
      omni_var.get_session('fs', null::omni_vfs.remote_fs),
      'creds.txt'
    )
  - query: select octet_length(convert_from(
        omni_vfs.read(
          omni_var.get_session(
              'fs',
              null::omni_vfs.remote_fs
          ),
          'creds.txt'
        ),
        'utf8'
      ))
    results:
    - octet_length: 142

- name: does not update credentials in a file store during transaction
  commit: true
  steps:
  - insert into creds.credentials (name, value) values ('b', 'c')
  - query: select octet_length(convert_from(
        omni_vfs.read(
          omni_var.get_session(
              'fs',
              null::omni_vfs.remote_fs
          ),
          'creds.txt'
        ),
        'utf8'
      ))
    results:
    - octet_length: 142

- name: but it does update credentials in a file store after the transaction
  query: >
    select
      octet_length(convert_from(
        omni_vfs.read(
          omni_var.get_session(
            'fs',
            null::omni_vfs.remote_fs
          ),
          'creds.txt'
        ),
        'utf8'
      ))
  results:
    - octet_length: 279

- name: imports credentials from a file store
  commit: true
  steps:
  - select omni_credentials.instantiate_file_store(filename => 'creds.txt', schema => 'creds1')
  - query: select name, value from creds1.credentials
    results:
    - name: a
      value: b
    - name: b
      value: c

- name: updating credentials file
  commit: true
  query: insert into creds1.credentials (name, value) values ('c', 'd')

- name: it does not propagate back right away
  query: select * from creds.credentials where name = 'c'
  results: [ ]

- name: but it does if explicitly reloaded
  steps:
  - select creds.credential_file_store_reload(filename) from creds.credential_file_stores
  - query: select name, value from creds.credentials where name = 'c'
    results:
    - name: c
      value: d
