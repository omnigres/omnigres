$schema: "https://raw.githubusercontent.com/omnigres/omnigres/master/pg_yregress/schema.json"
instance:
  init:
  - create extension omni_vfs cascade
  - create extension omni_credentials cascade
  - create schema creds
  # FIXME: we use PATH because we can't set env variables yet
  - select omni_credentials.instantiate('creds', env_var => 'PATH')
  - create schema creds1
  # FIXME: we use PATH because we can't set env variables yet
  - select omni_credentials.instantiate('creds1', env_var => 'PATH')
  - select omni_vfs.write(omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'), '/creds.json', decode('W3t9XQ==', 'base64'), create_file => true)
  - select omni_vfs.write(omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'), '/fl8ghs9h3v2x9j02e7bfv85n6v1b7yd62o3y94n84d8kn2z6file7random23kfjzo28lmns.json', decode('W3t9XQ==', 'base64'), create_file => true)
tests:

- name: exports credentials to a file store upon instantiation
  commit: true
  steps:
  - insert into creds.credentials (name, value) values ('a', 'b')
  - select omni_credentials.instantiate_file_store(
      omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
      'creds.json',
      'creds'
    )
  - query: select octet_length(convert_from(
        omni_vfs.read(
          omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
          'creds.json'
        ),
        'utf8'
      ))
    results:
    - octet_length: 191

- name: does not update credentials in a file store during transaction
  commit: true
  steps:
  - insert into creds.credentials (name, value) values ('b', 'c')
  - query: select octet_length(convert_from(
        omni_vfs.read(
          omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
          'creds.json'
        ),
        'utf8'
      ))
    results:
    - octet_length: 191

- name: but it does update credentials in a file store after the transaction
  query: >
    select
      octet_length(convert_from(
        omni_vfs.read(
          omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
          'creds.json'
        ),
        'utf8'
      ))
  results:
    - octet_length: 382

- name: imports credentials from a file store
  commit: true
  steps:
  - select omni_credentials.instantiate_file_store(
      omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
      'creds.json',
      'creds1'
    )
  - query: select * from creds1.credentials
    results:
    - name: a
      value: b
      kind: credential
      principal: yregress
      scope: {"all": true}
    - name: b
      value: c
      kind: credential
      principal: yregress
      scope: {"all": true}

- name: updating credentials file
  commit: true
  query: insert into creds1.credentials (name, value) values ('c', 'd')

- name: it does not propagate back right away
  query: select * from creds.credentials where name = 'c'
  results: [ ]

- name: but it does if explicitly reloaded
  steps:
  - select creds.credential_file_store_reload(filename) from creds.credential_file_stores
  - query: select name, value from creds.credentials where name = 'c'
    results:
    - name: c
      value: d

- name: long filename is handled gracefully
  tests:
  - name: long filename filestore is synchronized with credentials
    steps:
      - select omni_credentials.instantiate_file_store(
          omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
          'fl8ghs9h3v2x9j02e7bfv85n6v1b7yd62o3y94n84d8kn2z6file7random23kfjzo28lmns.json',
          'creds'
        )
      - query: select octet_length(convert_from(
            omni_vfs.read(
              omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
              'fl8ghs9h3v2x9j02e7bfv85n6v1b7yd62o3y94n84d8kn2z6file7random23kfjzo28lmns.json'
            ),
            'utf8'
          ))
        results:
          - octet_length: 382

  - name: long filename is truncated manually. function name in catalog matches function_name in credential_file_stores
    steps:
    - select omni_credentials.instantiate_file_store(
        omni_vfs.local_fs('../../../../extensions/omni_credentials/tests'),
        'fl8ghs9h3v2x9j02e7bfv85n6v1b7yd62o3y94n84d8kn2z6file7random23kfjzo28lmns.json',
        'creds'
      )
    - query: select p.proname from pg_catalog.pg_proc p left join pg_catalog.pg_namespace n on n.oid = p.pronamespace where n.nspname = 'creds' and p.proname = (
          select function_name
          from creds.credential_file_stores
          where filename = '/fl8ghs9h3v2x9j02e7bfv85n6v1b7yd62o3y94n84d8kn2z6file7random23kfjzo28lmns.json'
        )
      results:
        - proname: vfs_fl8ghs9h3v2x9j02e7bfv85n6v1b7yd62o3y94n84d8kn2z6file7random

- name: destroy the backend information
  query: delete
         from omni_vfs.local_fs_mounts
  commit: true