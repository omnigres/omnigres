name: Profile omni_schema.dependency

on:
    push:
      paths:
        - 'src/**'
        - 'omni_schema/**'
        - '.github/workflows/test-omnigres.yml'
    pull_request:

jobs:
  profile-dependency:
    runs-on: ubuntu-latest

    steps:
    - name: 🧱 Checkout code
      uses: actions/checkout@v3

    - name: 🛠️ Install system packages
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake gcc make libreadline-dev libssl-dev zlib1g-dev flex bison libxml2-dev libxslt1-dev libpam-dev


    - name: 🔨 Build Omnigres
      run: |
        cmake -S . -B build
        cmake --build build

    - name: 🧪 Init PGDATA using Omnigres initdb
      run: |
        build/src/initdb -D /tmp/pgdata


    - name: 🚀 Start Omnigres PostgreSQL
      run: |
        build/src/postgres -D /tmp/pgdata -k /tmp > /tmp/logfile 2>&1 &
        sleep 5
        build/src/pg_isready -h /tmp

    - name: 🧪 Run test queries
      run: |
        build/src/psql -h /tmp -d postgres -c "CREATE EXTENSION omnigres;"
        build/src/psql -h /tmp -d postgres -f sql/omni_schema.sql
        build/src/psql -h /tmp -d postgres -c "SELECT count(*) FROM omni_schema.dependency LIMIT 1;" || cat /tmp/logfile
